---
title: "p8105_hw6_qw2331"
output: github_document
---

```{r setup, echo = FALSE, message = FALSE}
library(tidyverse)
library(patchwork)

knitr::opts_chunk$set(
  fig.width = 10,
  fig.asp = .6,
  out.width = "90%",
  message = FALSE,
  warning = FALSE
)

theme_set(theme_minimal() + theme(legend.position = "bottom"))

options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)

scale_colour_discrete = scale_colour_viridis_d
scale_fill_discrete = scale_fill_viridis_d
```


## Problem 1

### 1.1 Load the data
```{r data import}
baby_bwt_raw <- 
  read_csv("./data/birthweight.csv")
```


### 1.2 Clean the data
```{r data clean}
# Convert numeric to factor
race <- c("White", "Black", "Asian", "Puerto Rican", "Other", "Unkown")

baby_bwt_df <- 
  baby_bwt_raw %>% 
  mutate(
    babysex = factor(recode(babysex, `1` = "male", `2` = "female")),
    malform = factor(recode(malform, `0` = "absent", `1` = "present")),
    frace = factor(race[frace]),
    mrace = factor(race[mrace])
  ) %>% 
  distinct()

# Check missing values
baby_bwt_df %>% 
  is.na() %>% 
  colSums()
```


### 1.3 Propose a regression model

**1.3.1 Distribution of target variable `brithweight`**
```{r}
baby_bwt_df %>% 
  ggplot(aes(bwt)) + 
  geom_histogram(aes(y = ..density..), fill = "orange") +
  geom_density(alpha = .4) + 
  labs(
    title = "Density of birthweight",
    x = "Birth Weight (grams)",
    y = "Density"
  )
```

**1.3.2 Summary statistics and check outliers**
```{r}
# Check for missing values
# Or a brief data review using function str()
summary(baby_bwt_df)

# Check outliers using boxplots
pivotdata <- 
  baby_bwt_df %>% 
  select(2:6, 8, 10:12, 17:18, 20) %>% 
  pivot_longer(
    everything(),
    names_to = "variable",
    values_to = "value"
  )

pivotdata %>% 
  ggplot(aes(factor(variable), value)) + 
  geom_boxplot(
    aes(color = variable), 
    show.legend = FALSE, outlier.size = .8) + 
  facet_wrap(~variable, scale = "free") + 
  labs(
    title = "Boxplots of 12 numeric variables",
    x = "Variable",
    y = "Value"
  )
```

**1.3.3 Correlation Matrix**
```{r}
# Create a correlation matrix
cordata <- 
  baby_bwt_df %>% 
  select(2:6, 8, 10:12, 17:18, 20) %>% 
  cor() %>% 
  round(3)

ggcorrplot::ggcorrplot(
  cordata, type = "lower", hc.order = TRUE, lab = TRUE, lab_size = 3) + 
  guides(
    fill = guide_legend(title = "Pearson\nCorrelation")
  )
```

**1.3.4 Fit a regression model and diagnostics**
```{r}
# Fit a model
baby_bwt_df <- 
  baby_bwt_df %>% 
  select(babysex, bhead, blength, bwt, gaweeks)

mod1 <- lm(bwt ~ bhead + blength, data = baby_bwt_df)

# Present the output
mod1 %>% 
  broom::tidy() %>% 
  select(term, estimate, p.value) %>% 
  knitr::kable(digits = 3)

# Diagnostics
# Residuals vs. Fits plot
res_fit_plot <-   
  baby_bwt_df %>% 
  modelr::add_residuals(mod1) %>% 
  modelr::add_predictions(mod1) %>% 
  ggplot(aes(x = pred, y = resid)) + 
  geom_point(size = 1.5, alpha = .4) + 
  geom_hline(yintercept = 0, linetype = "dotted") + 
  labs(
    title = "Residuals vs. Fitted",
    x = "Fitted values",
    y = "Residuals"
  )

# QQ plot
qq_plot <- 
  baby_bwt_df %>% 
  ggplot(aes(sample = bwt)) + 
  geom_qq(alpha = .4) + 
  geom_qq_line(linetype = "dotted") + 
  labs(
    title = "Normal Q-Q",
    x = "Theoretical Quantiles",
    y = "Sample Quantiles"
  )

res_fit_plot + qq_plot
```

**Modeling process:**  
+ We firstly check the distribution of the target variable `bwt` and find out this variable follows normal distribution  
+ Then check out the missing values and outliers for numeric variables  
+ Visualize the correlation matrix and choose variables `bhead` and `blength` as these two variables reflect high correlations with the target variable `bwt`  
+ Build a linear regression model with low level of complexity

